



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/planet.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>Docker in QEMU/KVM - ansemjo's docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#docker-in-qemukvm" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="ansemjo's docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                ansemjo's docs
              </span>
              <span class="md-header-nav__topic">
                Docker in QEMU/KVM
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/ansemjo/wiki/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      ansemjo/wiki
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../index.html" title="Home" class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../personal/löschungsantrag.html" title="Personal" class="md-tabs__link">
          Personal
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="index.html" title="Rechenzentrum" class="md-tabs__link md-tabs__link--active">
          Rechenzentrum
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../security/secureboot.html" title="Security" class="md-tabs__link">
          Security
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tips/ansible.html" title="Tips" class="md-tabs__link">
          Tips
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="ansemjo's docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    ansemjo's docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/ansemjo/wiki/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      ansemjo/wiki
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../software.html" title="Software" class="md-nav__link">
      Software
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Personal
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Personal
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../personal/löschungsantrag.html" title="DSGVO Löschungsantrag" class="md-nav__link">
      DSGVO Löschungsantrag
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../personal/versicherungen.html" title="Versicherungen" class="md-nav__link">
      Versicherungen
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Rechenzentrum
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Rechenzentrum
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="index.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="bootstrap.html" title="Bootstrap" class="md-nav__link">
      Bootstrap
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Docker in QEMU/KVM
      </label>
    
    <a href="docker-in-kvm.html" title="Docker in QEMU/KVM" class="md-nav__link md-nav__link--active">
      Docker in QEMU/KVM
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boot-a-virtual-machine" title="Boot a Virtual Machine" class="md-nav__link">
    Boot a Virtual Machine
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#via-text-console" title="Via Text Console" class="md-nav__link">
    Via Text Console
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#via-vnc-viewer" title="Via VNC Viewer" class="md-nav__link">
    Via VNC Viewer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-coreos-to-disk" title="Install CoreOS to Disk" class="md-nav__link">
    Install CoreOS to Disk
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-ignition" title="Prepare Ignition" class="md-nav__link">
    Prepare Ignition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#miscellaneous" title="Miscellaneous" class="md-nav__link">
    Miscellaneous
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fixed-dhcp-address" title="Fixed DHCP Address" class="md-nav__link">
    Fixed DHCP Address
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-client-configuration" title="SSH Client Configuration" class="md-nav__link">
    SSH Client Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="flynn.html" title="Flynn" class="md-nav__link">
      Flynn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="kvm-on-alpine.html" title="KVM on Alpine" class="md-nav__link">
      KVM on Alpine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="netboot.html" title="Network Boot" class="md-nav__link">
      Network Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tls-host-aliases.html" title="TLS for Host Aliases" class="md-nav__link">
      TLS for Host Aliases
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Security
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Security
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../security/secureboot.html" title="Secureboot" class="md-nav__link">
      Secureboot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../security/systemd-decryption-target.html" title="Systemd Disk Decryption Target" class="md-nav__link">
      Systemd Disk Decryption Target
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../security/zfs-in-place-encryption.html" title="ZFS in-place Encryption" class="md-nav__link">
      ZFS in-place Encryption
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Tips
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Tips
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/ansible.html" title="Ansible" class="md-nav__link">
      Ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/backblaze.html" title="Backblaze" class="md-nav__link">
      Backblaze
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/coreos.html" title="CoreOS" class="md-nav__link">
      CoreOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/docker.html" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/freeipa.html" title="FreeIPA" class="md-nav__link">
      FreeIPA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/git.html" title="Git" class="md-nav__link">
      Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/gitlab.html" title="Gitlab" class="md-nav__link">
      Gitlab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/restic.html" title="Restic" class="md-nav__link">
      Restic
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/tor.html" title="Tor" class="md-nav__link">
      Tor
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#boot-a-virtual-machine" title="Boot a Virtual Machine" class="md-nav__link">
    Boot a Virtual Machine
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#via-text-console" title="Via Text Console" class="md-nav__link">
    Via Text Console
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#via-vnc-viewer" title="Via VNC Viewer" class="md-nav__link">
    Via VNC Viewer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-coreos-to-disk" title="Install CoreOS to Disk" class="md-nav__link">
    Install CoreOS to Disk
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-ignition" title="Prepare Ignition" class="md-nav__link">
    Prepare Ignition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#miscellaneous" title="Miscellaneous" class="md-nav__link">
    Miscellaneous
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fixed-dhcp-address" title="Fixed DHCP Address" class="md-nav__link">
    Fixed DHCP Address
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh-client-configuration" title="SSH Client Configuration" class="md-nav__link">
    SSH Client Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ansemjo/wiki/edit/master/docs/rechenzentrum/docker-in-kvm.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="docker-in-qemukvm">Docker in QEMU/KVM</h1>
<p>Some applications may require a properly isolated Docker engine where users of the API have every freedom but when they must not be able to compromise the host security. Since access to the Docker socket is equivalent to being <code>root</code> (<a href="https://opensource.com/article/18/10/podman-more-secure-way-run-containers">or worse</a>) we must preferably run the engine on a seperate machine.</p>
<p>Long story short: virtualization with QEMU/KVM provides all the required isolation and CoreOS is easy to deploy and bundles Docker by default.</p>
<p>The following steps are designed for a CentOS 7.6 hypervisor.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>First of all, we need to prepare our hypervisor, so install QEMU and libvirt.</p>
<div class="codehilite"><pre><span></span>yum install qemu-kvm libvirt
modprobe kvm
systemctl enable --now libvirtd
</pre></div>


<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We are going to use <code>virt-install</code> as well, however the version in EPEL is not recent enough to use the <code>kernel=</code> and<code>initrd=</code> arguments with <code>--location</code>. Thus prefer a local manager and append <code>--connect qemu+ssh://root@hypervisor/system</code> to <code>virsh</code> or <code>virt-install</code> commands.</p>
</div>
<h2 id="boot-a-virtual-machine">Boot a Virtual Machine</h2>
<p>There is <a href="https://coreos.com/os/docs/latest/booting-with-libvirt.html">a guide</a> on how to boot CoreOS with libvirt but I prefer to perform a clean installation to disk. Therefore we need to boot CoreOS to RAM and deploy using an Ignition configuration.</p>
<h3 id="via-text-console">Via Text Console</h3>
<p>If you don't want to bother with VNC connections and would prefer to install via a text
console on the hypervisor itself, you can download and run the CoreOS <code>vmlinuz</code> and <code>cpio.gz</code> directly:</p>
<div class="codehilite"><pre><span></span>virt-install --name runner --memory <span class="m">4096</span> --vcpus <span class="m">4</span> <span class="se">\</span>
  --disk <span class="nv">size</span><span class="o">=</span><span class="m">20</span>,bus<span class="o">=</span>virtio --hvm --rng /dev/urandom <span class="se">\</span>
  --autostart --nographics --console pty,target_type<span class="o">=</span>virtio <span class="se">\</span>
  --location <span class="s2">&quot;https://stable.release.core-os.net/amd64-usr/current/,kernel=coreos_production_pxe.vmlinuz,initrd=coreos_production_pxe_image.cpio.gz&quot;</span> <span class="se">\</span>
  --extra-args <span class="s2">&quot;coreos.autologin console=ttyS0&quot;</span> <span class="se">\</span>
  --os-variant virtio26
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember to append a <code>--connect</code> string if you are connecting to a remote libvirt socket.</p>
</div>
<p>If you prefer to download and verify <a href="https://stable.release.core-os.net/amd64-usr/current/coreos_production_iso_image.iso">an ISO</a> locally instead, you can substitute:</p>
<div class="codehilite"><pre><span></span>  --location /tmp/coreos.iso,kernel=/coreos/vmlinuz,initrd=/coreos/cpio.gz \
</pre></div>


<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can find files inside an ISO with <code>isoinfo -Jf -i /path/to/iso</code>.</p>
</div>
<h3 id="via-vnc-viewer">Via VNC Viewer</h3>
<p>Apart from using VNC, we are going to use <a href="https://netboot.xyz">netboot.xyt</a> in this approach. This is possible with <code>virt-install</code> version 1.5.0 on CentOS 7.</p>
<p>First, download the netboot image:</p>
<div class="codehilite"><pre><span></span>cd /var/lib/libvirt/boot
curl -LO https://boot.netboot.xyz/ipxe/netboot.xyz.iso
</pre></div>


<p>Now create the virtual machine with <code>virt-install</code>:</p>
<div class="codehilite"><pre><span></span>virt-install --name runner --memory 4096 --vcpus 4 \
  --disk size=20,bus=virtio --hvm --rng /dev/urandom \
  --autostart --cdrom /var/lib/libvirt/boot/netboot.xyz.iso \
  --graphics vnc,listen=0.0.0.0 --noautoconsole \
  --os-variant virtio26
</pre></div>


<p>This should start the installation process and enable a VNC console. You can check the port with
<code>virsh vncdisplay runner</code> and verify with <code>ss -tln</code>. In my case <code>:0</code> corresponds to port 5900 on the
host, so temporarily open that port in the firewall:</p>
<div class="codehilite"><pre><span></span>firewall-cmd --add-port 5900/tcp
</pre></div>


<p>Connect with your favourite VNC client and complete the installation.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can't currently change the keyboard map on the console. Set a password with
<code>sudo passwd core</code> and connect with <code>ssh</code> instead if you run into problems.</p>
</div>
<h2 id="install-coreos-to-disk">Install CoreOS to Disk</h2>
<h3 id="prepare-ignition">Prepare Ignition</h3>
<p>By now you should have prepared an Ignition configuration. There is of course a lot of variation possible here but most importantly you should enable <code>rngd.service</code> and <code>docker.service</code> and make sure that you can connect with SSH public keys. Mine looks somewhat like this:</p>
<div class="codehilite"><pre><span></span><span class="nn">---</span>
<span class="c1"># enable docker service</span>
<span class="nt">systemd</span><span class="p">:</span>
  <span class="nt">units</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rngd.service</span>
      <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker.service</span>
      <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="c1"># ssh public keys</span>
<span class="nt">passwd</span><span class="p">:</span>
  <span class="nt">users</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">core</span>
      <span class="nt">ssh_authorized_keys</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="c1"># add your keys here</span>

<span class="c1"># automatic updates during maintenance window</span>
<span class="nt">locksmith</span><span class="p">:</span>
  <span class="nt">reboot_strategy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">reboot</span>
  <span class="nt">window_start</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">04:00</span>
  <span class="nt">window_length</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3h</span>

<span class="c1"># enable console autologin</span>
<span class="nt">storage</span><span class="p">:</span>
  <span class="nt">filesystems</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">OEM</span>
      <span class="nt">mount</span><span class="p">:</span>
        <span class="nt">device</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/dev/disk/by-label/OEM</span>
        <span class="nt">format</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ext4</span>
  <span class="nt">files</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">filesystem</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">OEM</span>
      <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/grub.cfg</span>
      <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0644</span>
      <span class="nt">append</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">contents</span><span class="p">:</span>
        <span class="nt">inline</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">set linux_append=&quot;$linux_append coreos.autologin&quot;</span>
</pre></div>


<h3 id="installation">Installation</h3>
<p>After transpiling, I am using <a href="https://surge.sh">surge.sh</a> to host small static files quickly. Download the configuration and finally install CoreOS to disk:</p>
<div class="codehilite"><pre><span></span>curl -LO <span class="s2">&quot;https://ks.surge.sh/coreos/docker.json&quot;</span>
sudo coreos-install -d /dev/vda -i docker.json
sudo udevadm settle
sudo reboot
</pre></div>


<h2 id="miscellaneous">Miscellaneous</h2>
<h3 id="fixed-dhcp-address">Fixed DHCP Address</h3>
<p>You can add a fixed address for this virtual machine by creating an IP assignment for its MAC address with <code>virsh</code>:</p>
<div class="codehilite"><pre><span></span>virsh net-dhcp-leases default   <span class="c1"># see current leases</span>
virsh net-update default add-last ip-dhcp-host <span class="se">\</span>
  --xml <span class="s2">&quot;&lt;host mac=&#39;52:54:00:e7:b6:4d&#39; ip=&#39;192.168.122.2&#39; /&gt;&quot;</span> <span class="se">\</span>
  --live --config
</pre></div>


<h3 id="ssh-client-configuration">SSH Client Configuration</h3>
<p>Add an appropriate SSH config on the hypervisor:</p>
<div class="codehilite"><pre><span></span>Host runner
  User core
  HostName 192.168.122.2
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="bootstrap.html" title="Bootstrap" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Bootstrap
              </span>
            </div>
          </a>
        
        
          <a href="flynn.html" title="Flynn" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Flynn
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright (c) 2018 Anton Semjonov, licensed under Creative Commons BY-SA 4.0 (https://semjonov.de/license)
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>