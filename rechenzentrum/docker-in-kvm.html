<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Anton Semjonov">
  <link rel="shortcut icon" href="../assets/planet.png">
  
  <title>Docker in QEMU/KVM - ansemjo's docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Docker in QEMU/KVM";
    var mkdocs_page_input_path = "rechenzentrum/docker-in-kvm.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> ansemjo's docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../software.html">Software</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Personal</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../personal/löschungsantrag.html">DSGVO Löschungsantrag</a>
                </li>
                <li class="">
                    
    <a class="" href="../personal/versicherungen.html">Versicherungen</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Rechenzentrum</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="index.html">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="bootstrap.html">Bootstrap</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="docker-in-kvm.html">Docker in QEMU/KVM</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#docker-in-qemukvm">Docker in QEMU/KVM</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#prerequisites">Prerequisites</a></li>
        
            <li><a class="toctree-l4" href="#boot-a-coreos-virtual-machine">Boot a CoreOS Virtual Machine</a></li>
        
            <li><a class="toctree-l4" href="#install-coreos-to-disk">Install CoreOS to Disk</a></li>
        
            <li><a class="toctree-l4" href="#miscellaneous">Miscellaneous</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="flynn.html">Flynn</a>
                </li>
                <li class="">
                    
    <a class="" href="kvm-on-alpine.html">KVM on Alpine</a>
                </li>
                <li class="">
                    
    <a class="" href="netboot.html">Network Boot</a>
                </li>
                <li class="">
                    
    <a class="" href="tls-host-aliases.html">TLS for Host Aliases</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Security</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../security/net-disk-decryption.html">Network Disk Decryption</a>
                </li>
                <li class="">
                    
    <a class="" href="../security/secureboot.html">Secureboot</a>
                </li>
                <li class="">
                    
    <a class="" href="../security/systemd-decryption-target.html">Systemd Disk Decryption Target</a>
                </li>
                <li class="">
                    
    <a class="" href="../security/zfs-in-place-encryption.html">ZFS in-place Encryption</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tips</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../tips/ansible.html">Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/backblaze.html">Backblaze</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bash.html">Bash</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/centos.html">CentOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/containers.html">Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/coreos.html">CoreOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/documentscan.html">Document Scanning</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/freeipa.html">FreeIPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/git.html">Git</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/gitlab.html">Gitlab</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/golang.html">Go</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/lenovo.html">Lenovo</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/openwrt.html">OpenWRT</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/python.html">Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/restic.html">Restic</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/serialdevices.html">Serial</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/tor.html">Tor</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ansemjo's docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Rechenzentrum &raquo;</li>
        
      
    
    <li>Docker in QEMU/KVM</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ansemjo/wiki/edit/master/docs/rechenzentrum/docker-in-kvm.md"> Edit on ansemjo/wiki</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="docker-in-qemukvm">Docker in QEMU/KVM<a class="headerlink" href="#docker-in-qemukvm" title="Permanent link">&para;</a></h1>
<p>Some applications may require a properly isolated Docker engine where users of the API have every freedom but when they must not be able to compromise the host security. Since access to the Docker socket is equivalent to being <code>root</code> (<a href="https://opensource.com/article/18/10/podman-more-secure-way-run-containers">or worse</a>) we must preferably run the engine on a seperate machine.</p>
<p>Long story short: virtualization with QEMU/KVM provides all the required isolation and CoreOS is easy to deploy and bundles Docker by default.</p>
<p>The following steps are designed for a CentOS 7 hypervisor.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<p>First of all, we need to prepare our hypervisor, so install QEMU and libvirt.</p>
<pre class="codehilite"><code>yum install qemu-kvm libvirt virt-install
modprobe kvm
systemctl enable --now libvirtd</code></pre>


<p>Make sure you have hardware virtualization available. If you&rsquo;re running in a virtual machine already you may need to enable passthrough explicitly. On an Intel machine you should have a module <code>kvm_intel</code> loaded as well.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We are going to use <code>virt-install</code> as well, however the version in EPEL is not recent enough to use the <code>kernel=</code> and<code>initrd=</code> arguments with <code>--location</code>. Thus prefer a local manager and append <code>--connect qemu+ssh://root@hypervisor/system</code> to <code>virsh</code> or <code>virt-install</code> commands.</p>
</div>
<h2 id="boot-a-coreos-virtual-machine">Boot a CoreOS Virtual Machine<a class="headerlink" href="#boot-a-coreos-virtual-machine" title="Permanent link">&para;</a></h2>
<p>There is <a href="https://coreos.com/os/docs/latest/booting-with-libvirt.html">a guide</a> on how to boot CoreOS with <code>libvirt</code> but I prefer to perform a clean installation to disk. Therefore we need to boot CoreOS to RAM and deploy using an Ignition configuration. Preferably, this is done with the provided PXE images.</p>
<p>Depending on your version of <code>virt-install</code> there are different installation methods available: in the terminal via text console or remotely over VNC.</p>
<h3 id="via-text-console-modern-virt-install">Via Text Console (modern <code>virt-install</code>)<a class="headerlink" href="#via-text-console-modern-virt-install" title="Permanent link">&para;</a></h3>
<p>If you don&rsquo;t want to bother with VNC connections and would prefer to install via a text console on the hypervisor itself, you can download and run the CoreOS <code>vmlinuz</code> and <code>cpio.gz</code> directly by specifying them in the <code>--location</code> argument:</p>
<pre class="codehilite"><code class="language-sh">virt-install --name core --memory 2048 --vcpus 2 \
  --accelerate --rng /dev/urandom --autostart --graphics none \
  --disk size=20,bus=virtio --os-variant virtio26 \
  --location &quot;https://stable.release.core-os.net/amd64-usr/current/,kernel=coreos_production_pxe.vmlinuz,initrd=coreos_production_pxe_image.cpio.gz&quot; \
  --extra-args &quot;coreos.autologin console=ttyS0&quot;</code></pre>


<p>If you prefer to download and verify <a href="https://stable.release.core-os.net/amd64-usr/current/coreos_production_iso_image.iso">an ISO</a> locally instead, you can substitute the <code>--location</code> argument:</p>
<pre class="codehilite"><code class="language-sh">  --location ../path/to/coreos.iso,kernel=/coreos/vmlinuz,initrd=/coreos/cpio.gz \</code></pre>


<p>This is useful when you&rsquo;re doing many installs to avoid the repeated downloads.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can find files inside an ISO with <code>isoinfo -Jf -i /path/to/disc.iso</code>.</p>
</div>
<h3 id="via-text-console-older-virt-install">Via Text Console (older <code>virt-install</code>)<a class="headerlink" href="#via-text-console-older-virt-install" title="Permanent link">&para;</a></h3>
<p>Older versions of <code>virt-install</code> &ndash; among them version 1.5.0 that is shipped with CentOS 7 &ndash; do not support the <code>--location ...,kernel=...,initrd=...</code> syntax and complain about unreachable URLs. In this case you can download the files and fake a Debain installation directory that is autodetected simply by passing the directory path to <code>virt-install</code>.</p>
<p>Download and verify the PXE image as per the CoreOS docs:</p>
<pre class="codehilite"><code class="language-sh">cd /var/lib/libvirt/images
mkdir -p coreos &amp;&amp; cd coreos
stable=https://stable.release.core-os.net/amd64-usr/current/
wget $stable/coreos_production_pxe.vmlinuz
wget $stable/coreos_production_pxe.vmlinuz.sig
wget $stable/coreos_production_pxe_image.cpio.gz
wget $stable/coreos_production_pxe_image.cpio.gz.sig
gpg --verify coreos_production_pxe.vmlinuz.sig
gpg --verify coreos_production_pxe_image.cpio.gz.sig</code></pre>


<p>Create a fake <code>MANIFEST</code> and a directory structure that mimics a Debian netboot installer:</p>
<pre class="codehilite"><code class="language-sh">mkdir -p amd64/current/images/netboot/debian-installer/amd64/
echo debian-installer &gt; amd64/current/images/MANIFEST
ln -sr coreos_production_pxe.vmlinuz amd64/current/images/netboot/debian-installer/amd64/linux
ln -sr coreos_production_pxe_image.cpio.gz amd64/current/images/netboot/debian-installer/amd64/initrd.gz</code></pre>


<p>Pass the <code>amd64</code> subdirectory as the installer location:</p>
<pre class="codehilite"><code class="language-sh">virt-install --name core --memory 2048 --vcpus 2 \
  --accelerate --rng /dev/urandom --autostart --graphics none \
  --disk size=20,bus=virtio --os-variant virtio26 \
  --location /var/lib/libvirt/images/coreos/amd64 \
  --extra-args &quot;coreos.autologin console=ttyS0&quot;</code></pre>


<p>This method is probably useful for other distributions that don&rsquo;t get detected automatically either as well.</p>
<h3 id="via-vnc-viewer">Via VNC Viewer<a class="headerlink" href="#via-vnc-viewer" title="Permanent link">&para;</a></h3>
<p>Sometimes an installer may just refuse to start on the serial console or you&rsquo;re more confident in a graphical installer. This method also applies when you want to use an ISO image without specifying additional kernel parameters.
As an example, this section uses an image of <a href="https://netboot.xyz">netboot.xyz</a>, which can be used to interactively boot many different distributions.</p>
<p>First, download the <code>netboot.xyz</code> image:</p>
<pre class="codehilite"><code>cd /var/lib/libvirt/boot
curl -LO https://boot.netboot.xyz/ipxe/netboot.xyz.iso</code></pre>


<p>Now create the virtual machine with <code>virt-install</code>, specifying the ISO with the <code>--cdrom</code> argument:</p>
<pre class="codehilite"><code>virt-install --name core --memory 2048 --vcpus 2 \
  --accelerate --rng /dev/urandom --autostart \
  --disk size=20,bus=virtio --os-variant virtio26 \
  --graphics vnc,listen=0.0.0.0 --noautoconsole \
  --cdrom /var/lib/libvirt/boot/netboot.xyz.iso</code></pre>


<p>This should start the installation process and enable a VNC console. You can check the port with <code>virsh vncdisplay runner</code> and verify with <code>ss -tln</code> if in doubt. In my case a default of <code>:0</code> corresponds to port 5900 on the host, so temporarily open that port in the firewall:</p>
<pre class="codehilite"><code>firewall-cmd --add-port 5900/tcp</code></pre>


<p>Connect with your favourite VNC client and complete the installation.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can&rsquo;t currently change the keyboard map on the console. Set a password with
<code>sudo passwd core</code> and connect with <code>ssh</code> instead if you run into problems.</p>
</div>
<h2 id="install-coreos-to-disk">Install CoreOS to Disk<a class="headerlink" href="#install-coreos-to-disk" title="Permanent link">&para;</a></h2>
<h3 id="prepare-ignition">Prepare Ignition<a class="headerlink" href="#prepare-ignition" title="Permanent link">&para;</a></h3>
<p>By now you should have prepared an Ignition configuration. There is of course a lot of variation possible here but most importantly you should enable <code>rngd.service</code> and <code>docker.service</code> and make sure that you can connect with SSH public keys. Mine looks somewhat like this:</p>
<pre class="codehilite"><code class="language-yaml">---
# enable docker service
systemd:
  units:
    - name: rngd.service
      enabled: yes
    - name: docker.service
      enabled: yes

# ssh public keys
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - # add your keys here

# automatic updates during maintenance window
locksmith:
  reboot_strategy: reboot
  window_start: 04:00
  window_length: 3h

# enable console autologin
storage:
  filesystems:
    - name: OEM
      mount:
        device: /dev/disk/by-label/OEM
        format: ext4
  files:
    - filesystem: OEM
      path: /grub.cfg
      mode: 0644
      append: true
      contents:
        inline: |
          set linux_append=&quot;$linux_append coreos.autologin&quot;</code></pre>


<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h3>
<p>After transpiling, I am using <a href="https://surge.sh">surge.sh</a> to host small static files quickly. Download the configuration and finally install CoreOS to disk:</p>
<pre class="codehilite"><code class="language-sh">curl -LO &quot;https://ks.surge.sh/coreos/docker.json&quot;
sudo coreos-install -d /dev/vda -i docker.json
sudo udevadm settle
sudo reboot</code></pre>


<h2 id="miscellaneous">Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permanent link">&para;</a></h2>
<h3 id="fixed-dhcp-address">Fixed DHCP Address<a class="headerlink" href="#fixed-dhcp-address" title="Permanent link">&para;</a></h3>
<p>You can add a fixed address for this virtual machine by creating an IP assignment for its MAC address with <code>virsh</code>:</p>
<pre class="codehilite"><code class="language-sh">virsh net-dhcp-leases default   # see current leases
virsh net-update default add-last ip-dhcp-host \
  --xml &quot;&lt;host mac='52:54:00:e7:b6:4d' ip='192.168.122.2' /&gt;&quot; \
  --live --config</code></pre>


<h3 id="ssh-client-configuration">SSH Client Configuration<a class="headerlink" href="#ssh-client-configuration" title="Permanent link">&para;</a></h3>
<p>Add an appropriate SSH config on the hypervisor:</p>
<pre class="codehilite"><code>Host runner
  User core
  HostName 192.168.122.2
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="flynn.html" class="btn btn-neutral float-right" title="Flynn">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="bootstrap.html" class="btn btn-neutral" title="Bootstrap"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright (c) 2019 Anton Semjonov.
Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" title="Creative Commons Attribution-ShareAlike 4.0">CC-BY-SA-4.0</a> license.
</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="bootstrap.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="flynn.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
