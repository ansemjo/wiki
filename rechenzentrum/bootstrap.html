<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Anton Semjonov">
  <link rel="shortcut icon" href="../assets/planet.png">
  
  <title>Bootstrap - ansemjo's docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Bootstrap";
    var mkdocs_page_input_path = "rechenzentrum/bootstrap.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> ansemjo's docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../software.html">Software</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Personal</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../personal/löschungsantrag.html">DSGVO Löschungsantrag</a>
                </li>
                <li class="">
                    
    <a class="" href="../personal/versicherungen.html">Versicherungen</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Rechenzentrum</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="index.html">Overview</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="bootstrap.html">Bootstrap</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#network-booting">Network Booting</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#combined-dhcp-responses">Combined DHCP responses</a></li>
        
            <li><a class="toctree-l4" href="#coreos-containers">CoreOS containers</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#bootstrap-process">Bootstrap Process</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#matchbox">Matchbox</a></li>
        
            <li><a class="toctree-l4" href="#install-centos-over-serial-cable">Install CentOS over Serial Cable</a></li>
        
            <li><a class="toctree-l4" href="#squid-proxy">Squid proxy</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="docker-in-kvm.html">Docker in QEMU/KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="flynn.html">Flynn</a>
                </li>
                <li class="">
                    
    <a class="" href="kvm-on-alpine.html">KVM on Alpine</a>
                </li>
                <li class="">
                    
    <a class="" href="netboot.html">Network Boot</a>
                </li>
                <li class="">
                    
    <a class="" href="tls-host-aliases.html">TLS for Host Aliases</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Security</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../security/net-disk-decryption.html">Network Disk Decryption</a>
                </li>
                <li class="">
                    
    <a class="" href="../security/secureboot.html">Secureboot</a>
                </li>
                <li class="">
                    
    <a class="" href="../security/systemd-decryption-target.html">Systemd Disk Decryption Target</a>
                </li>
                <li class="">
                    
    <a class="" href="../security/zfs-in-place-encryption.html">ZFS in-place Encryption</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tips</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../tips/ansible.html">Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/backblaze.html">Backblaze</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bash.html">Bash</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bios-updates.html">BIOS Updates</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/centos.html">CentOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/containers.html">Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/coreos.html">CoreOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/documentscan.html">Document Scanning</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/freeipa.html">FreeIPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/git.html">Git</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/gitlab.html">Gitlab</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/golang.html">Go</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/openwrt.html">OpenWRT</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/python.html">Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/restic.html">Restic</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/serialdevices.html">Serial</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/tor.html">Tor</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ansemjo's docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Rechenzentrum &raquo;</li>
        
      
    
    <li>Bootstrap</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ansemjo/wiki/edit/master/docs/rechenzentrum/bootstrap.md"> Edit on ansemjo/wiki</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This page needs tidying up.</p>
</div>
<h2 id="network-booting">Network Booting<a class="headerlink" href="#network-booting" title="Permanent link">&para;</a></h2>
<h3 id="combined-dhcp-responses">Combined DHCP responses<a class="headerlink" href="#combined-dhcp-responses" title="Permanent link">&para;</a></h3>
<p>Last time I changed my PXE procedure to use custom iPXE scripts and compiled iPXE binaries, I ran into the problem that the bootloop needs to be broken somehow, if you specify the iPXE binary as the boot target via DHCP and do <em>not</em> want to recompile your binary with new scripts embedded every time. This assumed <em>dumb</em> DHCP servers, which cannot react to different client classes. And while OpenWRT and the underlying <code>dnsmasq</code> are not exactly <em>dumb</em>, the necessary settings are not comfortably exposed in Luci. So I used an unused DHCP option to specify the <em>real</em> PXE boot target and an embedded iPXE script which reads this option and then chainloads. Whew!</p>
<p>Today I <a href="https://coreos.com/matchbox/docs/latest/network-setup.html#pxe-enabled-dhcp">learned</a> that clients can assemble responses from multiple DHCP servers and <code>dnsmasq</code> can act as a proxy just fine, meaning it will <em>only</em> serve the settings relevant to PXE booting and leave all the IP assignments, DNS settings, etc. to the main DHCP server in the network. Yay!</p>
<p>This means that the same server that shall act as the target for PXE booting (possibly even containing a gRPC-enabled <a href="https://coreos.com/matchbox/docs/latest/"><code>matchbox</code></a>) can <strong><em>also</em></strong> serve the relevant DHCP settings so clients will use it.</p>
<h3 id="coreos-containers">CoreOS containers<a class="headerlink" href="#coreos-containers" title="Permanent link">&para;</a></h3>
<p>The CoreOS team provides containers for both <code>matchbox</code> and <code>dnsmasq</code>:</p>
<ul>
<li><a href="https://quay.io/repository/coreos/matchbox">quay.io/coreos/matchbox</a></li>
<li><a href="https://quay.io/repository/coreos/dnsmasq">quay.io/coreos/dnsmasq</a></li>
</ul>
<p>Together with the sample <code>systemd</code> service files provided in matchbox releases in the <code>contrib/systemd/</code> subdirectory, these can easily be used to bootstrap a fully functional network boot target on top of CoreOS.</p>
<pre class="codehilite"><code class="language-systemd">[Unit]
Description=CoreOS matchbox Server
Documentation=https://github.com/coreos/matchbox

[Service]
Environment=&quot;IMAGE=quay.io/coreos/matchbox&quot;
Environment=&quot;VERSION=v0.7.1&quot;
Environment=&quot;MATCHBOX_ADDRESS=0.0.0.0:8080&quot;
Environment=&quot;MATCHBOX_RPC_ADDRESS=0.0.0.0:8081&quot;
Environment=&quot;MATCHBOX_LOG_LEVEL=debug&quot;
ExecStartPre=/usr/bin/mkdir -p /etc/matchbox
ExecStartPre=/usr/bin/mkdir -p /var/lib/matchbox/assets
ExecStart=/usr/bin/rkt run \
  --net=host \
  --inherit-env \
  --trust-keys-from-https \
  --mount volume=data,target=/var/lib/matchbox \
  --mount volume=config,target=/etc/matchbox \
  --volume data,kind=host,source=/var/lib/matchbox \
  --volume config,kind=host,source=/etc/matchbox \
  ${IMAGE}:${VERSION}

[Install]
WantedBy=multi-user.target</code></pre>


<pre class="codehilite"><code class="language-systemd">[Unit]
Description=CoreOS dnsmasq DHCP proxy and TFTP server
Documentation=https://github.com/coreos/matchbox

[Service]
Environment=&quot;IMAGE=quay.io/coreos/dnsmasq&quot;
Environment=&quot;VERSION=v0.5.0&quot;
Environment=&quot;NETWORK=172.26.63.1&quot;
Environment=&quot;MATCHBOX=172.26.63.242:8080&quot;
# replace with %H ?

ExecStart=/usr/bin/rkt run \
  --net=host \
  --trust-keys-from-https \
  ${IMAGE}:${VERSION} \
  --caps-retain=CAP_NET_ADMIN,CAP_NET_BIND_SERVICE,CAP_SETGID,CAP_SETUID,CAP_NET_RAW \
  -- -d -q \
    --dhcp-range=${NETWORK},proxy,255.255.255.0 \
    --enable-tftp --tftp-root=/var/lib/tftpboot \
    --dhcp-userclass=set:ipxe,iPXE \
    --pxe-service=tag:#ipxe,x86PC,&quot;PXE chainload to iPXE&quot;,undionly.kpxe \
    --pxe-service=tag:ipxe,x86PC,&quot;iPXE&quot;,http://${MATCHBOX}/boot.ipxe \
    --log-queries \
    --log-dhcp

[Install]
WantedBy=multi-user.target</code></pre>


<h2 id="bootstrap-process">Bootstrap Process<a class="headerlink" href="#bootstrap-process" title="Permanent link">&para;</a></h2>
<p>This is an overview of the necessary procedures to bootstrap the entire Rechenzentrum�:</p>
<ul>
<li>bootstrap the network boot target &lsquo;matchbox&rsquo;</li>
<li>boot and install CoreOS to disk</li>
<li>generate tls keys for <code>matchbox</code> gRPC</li>
<li>enable systemd services for <code>matchbox</code> and <code>dnsmasq</code></li>
<li><em>optionally</em> add custom iPXE scripts in <code>matchbox</code>&lsquo; assets and tweak boot option</li>
<li><em>optionally</em> download and store kernel and initramfs locally in assets</li>
<li>configure infrastructure with <code>terraform</code></li>
<li>use providers for <code>matchbox</code> and <code>vsphere</code>/<code>libvirt</code>/&hellip;</li>
<li>configure profiles for machines that bootstrap until you can <code>ssh</code> in</li>
<li><code>terraform apply</code> to bring them up and have them boot from pxe</li>
<li>use <code>ansible</code> to do proper deployments and configuration management</li>
<li><em>bonus points</em> if you use <code>terraform</code> state as inventory for ansible</li>
</ul>
<h3 id="matchbox">Matchbox<a class="headerlink" href="#matchbox" title="Permanent link">&para;</a></h3>
<p>Boot CoreOS into RAM through your preferred method, e.g. using the <a href="https://coreos.com/os/docs/latest/booting-with-iso.html">CoreOS ISO</a> or <a href="https://netboot.xyz/downloads/">netboot.xyz</a>. Then install to disk with <code>coreos-install</code>:</p>
<pre class="codehilite"><code>curl -Lo install.json https://ks.surge.sh/matchbox.json
sudo coreos-install -d /dev/sda -i install.json
sudo reboot</code></pre>


<p>Append <code>-o vmware_raw</code> to the installation command if you&rsquo;re installing on VMware and replace <code>/dev/sda</code> with <code>/dev/vda</code> if you&rsquo;re installing on KVM (or use scsi-virtio disks).</p>
<p>Reboot twice for the autologin to take effect. Then add this matchbox server in your DNS.</p>
<h3 id="install-centos-over-serial-cable">Install CentOS over Serial Cable<a class="headerlink" href="#install-centos-over-serial-cable" title="Permanent link">&para;</a></h3>
<p>Simply using <code>netboot.xyz.kpxe</code> is not sufficient when installing from network with only a serial connection (e.g. on my X10SBA) because it does not allow you to edit the kernel commandline - which does not include <code>console=ttyS0</code> by default. Thus boot into an iPXE shell and use the following script to start an interactive CentOS install over serial:</p>
<pre class="codehilite"><code>imgfree
set repo http://mirror.23media.de/centos/7/os/x86_64
kernel ${repo}/images/pxeboot/vmlinuz
initrd ${repo}/images/pxeboot/initrd.img
imgargs vmlinuz ramdisk_size=8192 console=ttyS0,115200 text method=${repo}/
boot</code></pre>


<p>Careful when copy-pasting though. I have had incomplete pastes which lead to a missing <code>_64</code> in the repo URL, etc.</p>
<h3 id="squid-proxy">Squid proxy<a class="headerlink" href="#squid-proxy" title="Permanent link">&para;</a></h3>
<p>Instead of mirroring multiple repositories locally, you could run a <a href="https://wiki.squid-cache.org/FrontPage">Squid</a> proxy in your network and point all <code>yum</code> clients at it. With some URL rewriting you can cache the same packages from many different mirrors in a deduplicated fashion.</p>
<p>I used the <a href="https://github.com/sameersbn/docker-squid">sameersbn/squid</a> image on a CoreOS host, started with the following arguments:</p>
<pre class="codehilite"><code>docker run -d --net host --name squid \
  -v /var/spool/squid:/var/spool/squid \
  -v /etc/squid:/etc/squid sameersbn/squid</code></pre>


<p>The configuration files cache all <code>.rpm</code>&lsquo;s from any mirrors. This is probably too open and broad to be used as a general proxy, so be careful.</p>
<p><strong><code>/etc/squid/storeid.db</code></strong>:</p>
<pre class="codehilite"><code># /etc/squid/squid.conf

acl safe_ports port 80 21 443
acl tls_ports  port 443
acl CONNECT method CONNECT

http_access deny !safe_ports
http_access deny CONNECT !tls_ports

http_access allow localhost
http_access allow all

http_port 3128

# cache yum/rpm downloads:
# http://ma.ttwagner.com/lazy-distro-mirrors-with-squid/
# https://serverfault.com/questions/837291/squid-and-caching-of-dnf-yum-downloads

cache_replacement_policy heap LFUDA     # least-frequently-used
cache_dir aufs /var/spool/squid 20000 16 256    # 20GB disk cache
maximum_object_size 4096 MB         # up to 4GB files

store_id_program /usr/lib/squid/storeid_file_rewrite /etc/squid/storeid.db  # rewrite all centos mirror urls

coredump_dir /var/spool/squid

refresh_pattern -i \.(deb|rpm|tar|tar.gz|tgz)$ 10080 90% 43200 override-expire ignore-no-cache ignore-no-store ignore-private
refresh_pattern .   0   20% 4320</code></pre>


<p><strong><code>/etc/squid/storeid.db</code></strong>:</p>
<pre class="codehilite"><code>\/([0-9\.\-]+)\/([a-z]+)\/(x86_64|i386)\/(.*\.d?rpm)    http://rpmcache.squid.internal/$1/$2/$3/$4</code></pre>


<p><strong>Note:</strong> the <code>storeid.db</code> rules need <strong>tabs</strong> as whitespace, not spaces! And during initial creation I found out that squid sends a <em>quoted</em> string to the helper, so using any regular expression with <code>(.*\.rpm)$</code> at the end did not match. Use <code>debug_options ALL,5</code> and grep for <code>storeId</code> if you&rsquo;re having problems.</p>
<p>Finally, simply add <code>proxy=http://url.to.your.proxy:3128</code> in your clients&rsquo; <code>/etc/yum.conf</code>.</p>
<h4 id="reverse-proxy">reverse proxy<a class="headerlink" href="#reverse-proxy" title="Permanent link">&para;</a></h4>
<p>With a small addition to your <code>squid.conf</code> you can also make Squid act as a reverse proxy (or &ldquo;accelerator&rdquo; in Squid terms) for a mirror of your choice, using <strong>the same cache</strong>. Although the wiki still says that <code>cache_peer</code> requests do not pass through the <code>storeid</code> helper, it in fact seems to do just that. At the time of this writing, the latest container uses <code>Squid Cache: Version 3.5.27</code> from Ubuntu&rsquo;s repositories.</p>
<pre class="codehilite"><code>...

http_port 3128
http_port 80  accel defaultsite=ftp.halifax.rwth-aachen.de no-vhost

cache_peer ftp.halifax.rwth-aachen.de parent 80 0 no-query originserver name=mirror

acl mirror dstdomain ftp.halifax.rwth-aachen.de
http_access allow mirror
cache_peer_access mirror allow mirror
cache_peer_access mirror deny all

...</code></pre>


<p>With this configuration, you could also use Squid as a mirror to install your machines via kickstart, because also the <code>.../os/x86_64/images/pxeboot/*</code> files will be cached. You might want to amend your <code>refresh_pattern</code> rules to account for that.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="docker-in-kvm.html" class="btn btn-neutral float-right" title="Docker in QEMU/KVM">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright (c) 2019 Anton Semjonov.
Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" title="Creative Commons Attribution-ShareAlike 4.0">CC-BY-SA-4.0</a> license.
</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="docker-in-kvm.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
