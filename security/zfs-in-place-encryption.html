<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Anton Semjonov">
  <link rel="shortcut icon" href="../assets/planet.png">
  
  <title>ZFS in-place Encryption - ansemjo's docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "ZFS in-place Encryption";
    var mkdocs_page_input_path = "security/zfs-in-place-encryption.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> ansemjo's docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../software.html">Software</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Personal</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../personal/löschungsantrag.html">DSGVO Löschungsantrag</a>
                </li>
                <li class="">
                    
    <a class="" href="../personal/versicherungen.html">Versicherungen</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Rechenzentrum</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rechenzentrum/index.html">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/bootstrap.html">Bootstrap</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/docker-in-kvm.html">Docker in QEMU/KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/flynn.html">Flynn</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/kvm-on-alpine.html">KVM on Alpine</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/netboot.html">Network Boot</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/tls-host-aliases.html">TLS for Host Aliases</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Security</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="net-disk-decryption.html">Network Disk Decryption</a>
                </li>
                <li class="">
                    
    <a class="" href="secureboot.html">Secureboot</a>
                </li>
                <li class="">
                    
    <a class="" href="systemd-decryption-target.html">Systemd Disk Decryption Target</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="zfs-in-place-encryption.html">ZFS in-place Encryption</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#zfs-in-place-encryption">ZFS in-place Encryption</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#hot-encryption">Hot Encryption</a></li>
        
            <li><a class="toctree-l4" href="#systemd-target">systemd Target</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tips</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../tips/ansible.html">Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/backblaze.html">Backblaze</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bash.html">Bash</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bios-updates.html">BIOS Updates</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/centos.html">CentOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/containers.html">Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/coreos.html">CoreOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/documentscan.html">Document Scanning</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/freeipa.html">FreeIPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/git.html">Git</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/gitlab.html">Gitlab</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/golang.html">Go</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/openwrt.html">OpenWRT</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/python.html">Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/restic.html">Restic</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/serialdevices.html">Serial</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/tor.html">Tor</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ansemjo's docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Security &raquo;</li>
        
      
    
    <li>ZFS in-place Encryption</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ansemjo/wiki/edit/master/docs/security/zfs-in-place-encryption.md"> Edit on ansemjo/wiki</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="zfs-in-place-encryption">ZFS in-place Encryption<a class="headerlink" href="#zfs-in-place-encryption" title="Permanent link">&para;</a></h1>
<p>There are basically two possibilities to encrypt an existing array&rsquo;s disks:</p>
<ol>
<li>
<p>perform in-place encryption of <em>cold</em> disks with <code>luksipc</code></p>
<ul>
<li>requires that you have enough free space at the end</li>
<li>will not work if your array is assembled from <code>/dev/disk/by-id/*</code> paths, since those will
  change</li>
</ul>
</li>
<li>
<p>iterate over <em>hot</em> disks by overwriting and resilvering each one</p>
<ul>
<li>will leave your array in a degraded but usable state</li>
<li>you should overwrite the entire disk to make sure plaintext traces are removed</li>
<li>depending on how full your array is you might need to write up to twice your raw accumulated
  disk size worth of data .. this takes <strong>a lot</strong> of time!</li>
</ul>
</li>
</ol>
<h2 id="hot-encryption">Hot Encryption<a class="headerlink" href="#hot-encryption" title="Permanent link">&para;</a></h2>
<p>I chose to use the latter method because there was not enough space at the end of the drives and I
was not sure how ZFS could handle the changed disk paths. A couple things to note:</p>
<ul>
<li>
<p>make sure you align all partitions / containers!</p>
<ul>
<li>check your <em>real</em> physical block size (the drive might lie)</li>
<li>check the <code>ashift</code> property of your pool</li>
</ul>
</li>
<li>
<p>use partitions, do not make the LUKS partition span the entire drive!</p>
<ul>
<li>begin the first partition at a multiple of your <code>pbs</code>, e.g. 4096 sectors / 2 MiB is a safe bet</li>
<li>account for the LUKS header (usually should be 2 MiB)</li>
<li>do not enlarge your partitions by too much, so you can replace them later on</li>
<li><strong>however</strong> make sure that the mapped device cannot be smaller than your original partition!</li>
</ul>
</li>
</ul>
<h3 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h3>
<p>For example, I originally had four <code>7809835008</code> sector partitions (<code>fdisk</code> uses 512 byte sectors
here).</p>
<table>
<thead>
<tr>
<th>Partition</th>
<th align="right">sectors (512 bytes)</th>
<th align="right">approximate size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Original ZFS</td>
<td align="right">7809835008</td>
<td align="right">3813396 MiB</td>
</tr>
<tr>
<td>Full disk</td>
<td align="right">7814037168</td>
<td align="right">~ 3815447 MiB</td>
</tr>
<tr>
<td>Nominal 4 TiB disk</td>
<td align="right">7812500000</td>
<td align="right">~ 3814697 MiB</td>
</tr>
<tr>
<td>New ZFS</td>
<td align="right">7811072000</td>
<td align="right">3814000 MiB</td>
</tr>
<tr>
<td>New LUKS</td>
<td align="right">7811076096</td>
<td align="right">3814002 MiB</td>
</tr>
</tbody>
</table>
<h3 id="rinse-repeat">Rinse &amp; Repeat<a class="headerlink" href="#rinse-repeat" title="Permanent link">&para;</a></h3>
<p>Assume the original pool looked like this:</p>
<pre class="codehilite"><code>kourier
  mirror-0                                                          ONLINE
    /dev/disk/by-id/ata-WDC_WD40EZRX-00SPEB0_WD-WCC4E0496927-part2  ONLINE
    /dev/disk/by-id/ata-HGST_HDN724040ALE640_PK1334PEHLZA1S-part2   ONLINE
  mirror-1                                                          ONLINE
    /dev/disk/by-id/ata-WDC_WD40EZRX-00SPEB0_WD-WCC4E0284683-part2  ONLINE
    /dev/disk/by-id/ata-HGST_HDN724040ALE640_PK1334PEHK98JS-part2   ONLINE</code></pre>


<p>Take the first drive offline:</p>
<pre class="codehilite"><code>export DISK=&quot;WDC_WD40EZRX-00SPEB0_WD-WCC4E0496927&quot;
zpool offline kourier ata-${DISK}-part2</code></pre>


<p>Overwrite with zeroes or random data:</p>
<pre class="codehilite"><code>dd if=/dev/zero of=/dev/disk/by-id/ata-${DISK} status=progress bs=1M</code></pre>


<p>Create a new partition table and one partition with your desired size (the UUID sets the partition
type to <code>FreeBSD ZFS</code>):</p>
<pre class="codehilite"><code class="language-bash">sfdisk /dev/disk/by-id/ata-${DISK} &lt;&lt;EOF
label: gpt
start=2M size=7811076096 type=516E7CBA-6ECF-11D6-8FF8-00022D09712B
EOF</code></pre>


<p>Create and open the LUKS container with your desired cipher / hash / keysize settings:</p>
<pre class="codehilite"><code class="language-bash">cryptsetup luksFormat /dev/disk/by-id/ata-${DISK}-part1
cryptsetup open /dev/disk/by-id/ata-${DISK}-part1 ${DISK}_LUKS</code></pre>


<p>Replace the drive in the pool and wait for it to resilver:</p>
<pre class="codehilite"><code class="language-bash">zpool replace kourier ata-${DISK}-part2 /dev/mapper/${DISK}_LUKS
watch -d zpool status -P</code></pre>


<p>Rinse and repeat with all four disks. This is what my pool looks like now:</p>
<pre class="codehilite"><code>kourier
  mirror-0                                                 ONLINE
    /dev/mapper/WDC_WD40EZRX-00SPEB0_WD-WCC4E0496927_LUKS  ONLINE
    /dev/mapper/HGST_HDN724040ALE640_PK1334PEHLZA1S_LUKS   ONLINE
  mirror-1                                                 ONLINE
    /dev/mapper/WDC_WD40EZRX-00SPEB0_WD-WCC4E0284683_LUKS  ONLINE
    /dev/mapper/HGST_HDN724040ALE640_PK1334PEHK98JS_LUKS   ONLINE</code></pre>


<h2 id="systemd-target"><code>systemd</code> Target<a class="headerlink" href="#systemd-target" title="Permanent link">&para;</a></h2>
<p>My next task will be to create proper dependencies for all my systemd services. I do not want my
system to block boot, so I can later login and manually decrypt the disks. However I also don&rsquo;t want
to have services randomly fail or attempt to create nonexistent paths because the zpool is not
imported yet. They should just queue and wait for me to decrypt the drives and then automatically
continue once I&rsquo;ve done that.</p>
<p>Useful pointers:</p>
<ul>
<li><code>systemd-cryptsetup@.service</code></li>
<li>bundling all encrypted disks in a <code>*.target</code></li>
<li><code>After=</code>, <code>RequiredBy=</code>/<code>WantedBy=</code> and <code>BindsTo=</code> properties of services</li>
<li><a href="https://www.freedesktop.org/software/systemd/man/systemd.unit.html">systemd.unit(5)</a></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See <a href="systemd-decryption-target.html">Systemd Decryption Target</a> for the finished result.</p>
</div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../tips/ansible.html" class="btn btn-neutral float-right" title="Ansible">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="systemd-decryption-target.html" class="btn btn-neutral" title="Systemd Disk Decryption Target"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright (c) 2019 Anton Semjonov.
Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" title="Creative Commons Attribution-ShareAlike 4.0">CC-BY-SA-4.0</a> license.
</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="systemd-decryption-target.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../tips/ansible.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
