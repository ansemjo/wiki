<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Anton Semjonov">
  <link rel="shortcut icon" href="../assets/planet.png">
  
  <title>Network Disk Decryption - ansemjo's docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Network Disk Decryption";
    var mkdocs_page_input_path = "security/net-disk-decryption.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> ansemjo's docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../software.html">Software</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Personal</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../personal/löschungsantrag.html">DSGVO Löschungsantrag</a>
                </li>
                <li class="">
                    
    <a class="" href="../personal/versicherungen.html">Versicherungen</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Rechenzentrum</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rechenzentrum/index.html">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/bootstrap.html">Bootstrap</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/docker-in-kvm.html">Docker in QEMU/KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/flynn.html">Flynn</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/kvm-on-alpine.html">KVM on Alpine</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/netboot.html">Network Boot</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/tls-host-aliases.html">TLS for Host Aliases</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Security</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="net-disk-decryption.html">Network Disk Decryption</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#network-disk-decryption">Network Disk Decryption</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#tang-server">tang server</a></li>
        
            <li><a class="toctree-l4" href="#clevis-client">clevis client</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="secureboot.html">Secureboot</a>
                </li>
                <li class="">
                    
    <a class="" href="systemd-decryption-target.html">Systemd Disk Decryption Target</a>
                </li>
                <li class="">
                    
    <a class="" href="zfs-in-place-encryption.html">ZFS in-place Encryption</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tips</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../tips/ansible.html">Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/backblaze.html">Backblaze</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bash.html">Bash</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/centos.html">CentOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/containers.html">Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/coreos.html">CoreOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/documentscan.html">Document Scanning</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/freeipa.html">FreeIPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/git.html">Git</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/gitlab.html">Gitlab</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/golang.html">Go</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/lenovo.html">Lenovo</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/openwrt.html">OpenWRT</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/python.html">Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/restic.html">Restic</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/serialdevices.html">Serial</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/tor.html">Tor</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ansemjo's docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Security &raquo;</li>
        
      
    
    <li>Network Disk Decryption</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ansemjo/wiki/edit/master/docs/security/net-disk-decryption.md"> Edit on ansemjo/wiki</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="network-disk-decryption">Network Disk Decryption<a class="headerlink" href="#network-disk-decryption" title="Permanent link">&para;</a></h1>
<p>Recently RedHat 7.4 introduced the possibility to bind your encrypted disks to a
network presence. It is called <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Network-Bound_Disk_Encryption.html">Network-Bound Disk Encryption</a>
and uses the projects <a href="https://github.com/latchset/tang">tang</a> and
<a href="https://github.com/latchset/clevis">clevis</a>.</p>
<p>In essence, an encrypted payload is transformed with some ECDH key exchange magic with
the tang server and the disk is decrypted automatically. If however the tang server is
unavailable, this method fails and you must fall back to manually entering a passphrase.</p>
<p>I decided this is a nice addition to <a href="systemd-decryption-target.html">my systemd decryption target</a>,
so here&rsquo;s how I implemented it:</p>
<h2 id="tang-server"><code>tang</code> server<a class="headerlink" href="#tang-server" title="Permanent link">&para;</a></h2>
<p>First of all, install a release of the <code>tang</code> server. There&rsquo;s a package for CentOS and
a package in the AUR for Arch Linux. There are probably others, too. But it shouldn&rsquo;t
be too hard to build it yourself either.</p>
<pre class="codehilite"><code>yum install tang</code></pre>


<p>I didn&rsquo;t like tang running on port 80 by default, so I changed it with <code>systemctl edit tangd.socket</code>:</p>
<pre class="codehilite"><code>[Socket]
ListenStream=
ListenStream=51653</code></pre>


<p>Start and enable the service. Make sure to open the firewall on that port.</p>
<pre class="codehilite"><code>systemctl enable --now tangd.socket</code></pre>


<p>You can now make sure that a key is present and print the public key:</p>
<pre class="codehilite"><code>tang-show-keys 51653
4yWvhO4ZthpAGHDmdMn78Pe2Bg0</code></pre>


<h2 id="clevis-client"><code>clevis</code> client<a class="headerlink" href="#clevis-client" title="Permanent link">&para;</a></h2>
<p>Now for the client part on my fileserver. There is a nice <a href="https://www.redhat.com/en/blog/easier-way-manage-disk-decryption-boot-red-hat-enterprise-linux-75-using-nbde">post</a> on the RedHat blog
describing the entire procedure. I&rsquo;m assuming you already have some encrypted disks that you want
to set up for network-bound decryption. First, install clevis:</p>
<pre class="codehilite"><code>yum install clevis clevis-luks</code></pre>


<p>And make sure that you can reach your tang server:</p>
<pre class="codehilite"><code>curl -f tang.yourdomain:51653/adv | jq .</code></pre>


<p>Now we bind a secret to this tang server and add it as a new key on our LUKS disks. This will
use the luksmeta storage, so you might want to take header backups on all disks to avoid data loss:</p>
<pre class="codehilite"><code>cryptsetup luksHeaderBackup /dev/disk/by-id/ata-... --header-backup-file ...</code></pre>


<p>Then bind the disks to the tang server:</p>
<pre class="codehilite"><code>clevis luks bind -d /dev/disk/by-id/ata-... \
  tang '{&quot;url&quot;:&quot;http://tang.yourdomain:51653&quot;}'

The advertisement contains the following signing keys:
4yWvhO4ZthpAGHDmdMn78Pe2Bg0

Do you wish to trust these keys? [ynYN] y
...</code></pre>


<p>Make sure the key matches the <code>tang-show-keys</code> output above! You&rsquo;ll be asked to initialize the LUKS
metadata storage and must then enter an existing passphrase to add the newly bound secret as a new
encryption key to your disk.</p>
<p>I didn&rsquo;t bother to setup automatic decryption on boot since I already have a semi-automatic decryption
environment in place with my systemd decryption target. I&rsquo;m fine with decrypting disks with <code>clevis</code>
manually:</p>
<pre class="codehilite"><code>clevis luks unlock -d /dev/disk/by-id/ata-... -n mappername</code></pre>


<p>However, I automated this for all four disks in my array with a small script, which reads the disks and
names from <code>/etc/crypttab</code> and then starts <a href="systemd-decryption-target.html#continueservice"><code>continue.service</code></a>:</p>
<pre class="codehilite"><code class="language-sh">#!/bin/sh

# unlock disks with tang and clevis
echo &quot;+ unlock disks&quot;
while read name disk opts; do
  echo &quot;  $disk&quot;
  clevis luks unlock -d &quot;$disk&quot; -n &quot;$name&quot;
done &lt; /etc/crypttab

# continue system startup
sleep 2
echo &quot;+ continue startup&quot;
systemctl start continue.service</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="secureboot.html" class="btn btn-neutral float-right" title="Secureboot">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../rechenzentrum/tls-host-aliases.html" class="btn btn-neutral" title="TLS for Host Aliases"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright (c) 2019 Anton Semjonov.
Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" title="Creative Commons Attribution-ShareAlike 4.0">CC-BY-SA-4.0</a> license.
</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../rechenzentrum/tls-host-aliases.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="secureboot.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
