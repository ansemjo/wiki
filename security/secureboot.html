<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Anton Semjonov">
  <link rel="shortcut icon" href="../assets/planet.png">
  
  <title>Secureboot - ansemjo's docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Secureboot";
    var mkdocs_page_input_path = "security/secureboot.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> ansemjo's docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../software.html">Software</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Personal</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../personal/löschungsantrag.html">DSGVO Löschungsantrag</a>
                </li>
                <li class="">
                    
    <a class="" href="../personal/versicherungen.html">Versicherungen</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Rechenzentrum</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../rechenzentrum/index.html">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/bootstrap.html">Bootstrap</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/docker-in-kvm.html">Docker in QEMU/KVM</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/flynn.html">Flynn</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/kvm-on-alpine.html">KVM on Alpine</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/netboot.html">Network Boot</a>
                </li>
                <li class="">
                    
    <a class="" href="../rechenzentrum/tls-host-aliases.html">TLS for Host Aliases</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Security</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="net-disk-decryption.html">Network Disk Decryption</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="secureboot.html">Secureboot</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#secureboot">Secureboot</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#tools">Tools</a></li>
        
            <li><a class="toctree-l4" href="#guides">Guides</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="systemd-decryption-target.html">Systemd Disk Decryption Target</a>
                </li>
                <li class="">
                    
    <a class="" href="zfs-in-place-encryption.html">ZFS in-place Encryption</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tips</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../tips/ansible.html">Ansible</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/backblaze.html">Backblaze</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/bash.html">Bash</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/centos.html">CentOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/containers.html">Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/coreos.html">CoreOS</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/documentscan.html">Document Scanning</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/freeipa.html">FreeIPA</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/git.html">Git</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/gitlab.html">Gitlab</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/golang.html">Go</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/lenovo.html">Lenovo</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/openwrt.html">OpenWRT</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/python.html">Python</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/restic.html">Restic</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/serialdevices.html">Serial</a>
                </li>
                <li class="">
                    
    <a class="" href="../tips/tor.html">Tor</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ansemjo's docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Security &raquo;</li>
        
      
    
    <li>Secureboot</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ansemjo/wiki/edit/master/docs/security/secureboot.md"> Edit on ansemjo/wiki</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="secureboot">Secureboot<a class="headerlink" href="#secureboot" title="Permanent link">&para;</a></h1>
<p>These are guides to install your system with your own secureboot keys and enforce
signed Linux kernels.</p>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h2>
<p>Some useful tools for this job:</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><a href="https://github.com/ansemjo/mkefikeys"><code>ansemjo/mkefikeys</code></a></td>
<td align="left">generate signing keys</td>
</tr>
<tr>
<td align="center"><a href="https://github.com/ansemjo/mksignkernels"><code>ansemjo/mksignkernels</code></a></td>
<td align="left">bundle and sign kernel images</td>
</tr>
</tbody>
</table>
<h2 id="guides">Guides<a class="headerlink" href="#guides" title="Permanent link">&para;</a></h2>
<h3 id="arch-linux">Arch Linux<a class="headerlink" href="#arch-linux" title="Permanent link">&para;</a></h3>
<p>TODO</p>
<h3 id="fedora">Fedora<a class="headerlink" href="#fedora" title="Permanent link">&para;</a></h3>
<h4 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h4>
<p>Do a somewhat standard installation on an UEFI system. I used the <code>Fedora 28 Server netinst</code> image.</p>
<p>During partitioning, make sure to select at least &ldquo;custom&rdquo; partitioning and add a seperate EFI system partition in <code>/boot/efi</code>. Tick the boxes to encrypt your <code>/</code> and any <code>swap</code> partitions you might create. Technically, a seperate <code>/boot</code> partition is not required with the bundled kernels we are going to use but Anaconda complains otherwise and you will not be able to boot the system after installation. You could probably do all these steps from within a live rescue system but I haven&rsquo;t tried that route yet.</p>
<h4 id="required-packages">Required Packages<a class="headerlink" href="#required-packages" title="Permanent link">&para;</a></h4>
<p>You will need to additionally (after a minimal setup) install:
* git
* make
* binutils
* sbsigntools</p>
<p>Then clone and install the above two tools: <code>mkefikeys</code> and <code>mksignkernels</code>.</p>
<pre class="codehilite"><code>cd /tmp/...
git clone https://github.com/ansemjo/mkefikeys
git clone https://github.com/ansemjo/mksignkernels
(cd mkefikeys &amp;&amp; make -f install.mk install)
(cd mksignkernels &amp;&amp; make -f install.mk install)</code></pre>


<h4 id="signing-keys">Signing keys<a class="headerlink" href="#signing-keys" title="Permanent link">&para;</a></h4>
<p>Create a set of signing keys in <code>/etc/efikeys</code>:</p>
<pre class="codehilite"><code>mkdir /etc/efikeys &amp;&amp; cd /etc/efikeys
mkefikeys certs der</code></pre>


<p>The <code>der</code> target is required to output DER-encoded certificates in case you need to install those in your firmware. This is the case for OVMF, i.e. KVM machines. My Thinkpad needs authenticated &ldquo;efi signature lists&rdquo; .. generate them with <code>mkefikeys auth</code>.</p>
<p>Copy files required for installation to the unencrypted ESP:</p>
<pre class="codehilite"><code>cp /etc/efikeys/*.cer /boot/efi</code></pre>


<p>Installing them in your firmware is out of the scope of this entry.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not enable Secureboot yet. We haven&rsquo;t signed anything yet and your system will fail to boot.</p>
</div>
<h4 id="sign-your-kernels">Sign your kernels<a class="headerlink" href="#sign-your-kernels" title="Permanent link">&para;</a></h4>
<p>Now we need to sign the kernels. Simply running <code>mksignkernels</code> will probably fail with a not-so-useful error message because something will be missing. On virtual machines the Intel microcode is usually not useful and thus not present. Add an empty <code>MICROCODE =</code> line in <code>/etc/mksignkernels.mk</code>.</p>
<p>Additionally, you&rsquo;ll want to use the same kernel commandline as is used for your  default installation. You can get the commandline of currently running kernel from <code>cat /proc/cmdline</code>.</p>
<pre class="codehilite"><code class="language-make"># blablabla
# ------- custom targets --------

MICROCODE = 
CMDLINE = whatever_your_default_kernel_uses</code></pre>


<p>Next, we need to create the output directory:</p>
<pre class="codehilite"><code>mkdir /boot/efi/EFI/Linux</code></pre>


<p>Running <code>mksignkernels</code> should succeed now. Otherwise check all the prerequisites:</p>
<ul>
<li>EFI stub in <code>/usr/lib/systemd/boot/efi/linuxx64.efi.stub</code></li>
<li>Signing keys in <code>/etc/efikeys/DatabaseKey.{key,crt}</code></li>
<li>Kernel in <code>/boot/vmlinuz-*</code></li>
<li>Initramfs in corresponding <code>/boot/initramfs-*.img</code></li>
</ul>
<h4 id="use-systemd-boot">Use systemd-boot<a class="headerlink" href="#use-systemd-boot" title="Permanent link">&para;</a></h4>
<p>Check that <code>systemd-boot</code> is installed and you are indeed running UEFI, yadda yadda ..</p>
<pre class="codehilite"><code>bootctl status</code></pre>


<p>To install it as the default bootloader, simply issue:</p>
<pre class="codehilite"><code>bootctl install</code></pre>


<p>To enable the selection prompt uncomment the <code>timeout</code> in <code>/boot/efi/loader/loader.conf</code>. Otherwise it directly boots the default kernel.</p>
<h4 id="sign-your-bootloader">Sign your bootloader<a class="headerlink" href="#sign-your-bootloader" title="Permanent link">&para;</a></h4>
<p>Before you reboot and attempt to enable Secureboot now, you need to sign the bootloader itself:</p>
<pre class="codehilite"><code>mksignkernels sign SIGN=/boot/efi/systemd/systemd-bootx64.efi
mksignkernels sign SIGN=/boot/efi/BOOT/BOOTX64.EFI</code></pre>


<p>I actually do not know if both are necessary, I just signed both just in case.</p>
<h4 id="reboot">Reboot<a class="headerlink" href="#reboot" title="Permanent link">&para;</a></h4>
<p>When you reboot you should see systemd-boot&rsquo;s selection prompt instead of GRUB. If that is the case, there should be an option to &ldquo;Reboot into Firmware Setup&rdquo;.
Do that and enable Secureboot now.</p>
<p>If all went fine you should be able to normally boot your system now. Starting your machine via GRUB should fail though, as neither GRUB nor any of the kernels it tries to boot are signed.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="systemd-decryption-target.html" class="btn btn-neutral float-right" title="Systemd Disk Decryption Target">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="net-disk-decryption.html" class="btn btn-neutral" title="Network Disk Decryption"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright (c) 2019 Anton Semjonov.
Licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/" title="Creative Commons Attribution-ShareAlike 4.0">CC-BY-SA-4.0</a> license.
</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="net-disk-decryption.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="systemd-decryption-target.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
