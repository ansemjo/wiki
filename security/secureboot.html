



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/planet.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.3.0">
    
    
      
        <title>Secureboot - ansemjo's docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.962652e9.js"></script>
    
    
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#secureboot" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="ansemjo's docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                ansemjo's docs
              </span>
              <span class="md-header-nav__topic">
                Secureboot
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/ansemjo/wiki/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      ansemjo/wiki
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../index.html" title="Home" class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../personal/löschungsantrag.html" title="Personal" class="md-tabs__link">
          Personal
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../rechenzentrum/index.html" title="Rechenzentrum" class="md-tabs__link">
          Rechenzentrum
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="net-disk-decryption.html" title="Security" class="md-tabs__link md-tabs__link--active">
          Security
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../tips/ansible.html" title="Tips" class="md-tabs__link">
          Tips
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="ansemjo's docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    ansemjo's docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/ansemjo/wiki/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      ansemjo/wiki
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../software.html" title="Software" class="md-nav__link">
      Software
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Personal
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Personal
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../personal/löschungsantrag.html" title="DSGVO Löschungsantrag" class="md-nav__link">
      DSGVO Löschungsantrag
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../personal/versicherungen.html" title="Versicherungen" class="md-nav__link">
      Versicherungen
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Rechenzentrum
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Rechenzentrum
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/index.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/bootstrap.html" title="Bootstrap" class="md-nav__link">
      Bootstrap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/docker-in-kvm.html" title="Docker in QEMU/KVM" class="md-nav__link">
      Docker in QEMU/KVM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/flynn.html" title="Flynn" class="md-nav__link">
      Flynn
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/kvm-on-alpine.html" title="KVM on Alpine" class="md-nav__link">
      KVM on Alpine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/netboot.html" title="Network Boot" class="md-nav__link">
      Network Boot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rechenzentrum/tls-host-aliases.html" title="TLS for Host Aliases" class="md-nav__link">
      TLS for Host Aliases
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Security
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Security
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="net-disk-decryption.html" title="Network Disk Decryption" class="md-nav__link">
      Network Disk Decryption
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Secureboot
      </label>
    
    <a href="secureboot.html" title="Secureboot" class="md-nav__link md-nav__link--active">
      Secureboot
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tools" title="Tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guides" title="Guides" class="md-nav__link">
    Guides
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arch-linux" title="Arch Linux" class="md-nav__link">
    Arch Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fedora" title="Fedora" class="md-nav__link">
    Fedora
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-packages" title="Required Packages" class="md-nav__link">
    Required Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signing-keys" title="Signing keys" class="md-nav__link">
    Signing keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-your-kernels" title="Sign your kernels" class="md-nav__link">
    Sign your kernels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-systemd-boot" title="Use systemd-boot" class="md-nav__link">
    Use systemd-boot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-your-bootloader" title="Sign your bootloader" class="md-nav__link">
    Sign your bootloader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reboot" title="Reboot" class="md-nav__link">
    Reboot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="systemd-decryption-target.html" title="Systemd Disk Decryption Target" class="md-nav__link">
      Systemd Disk Decryption Target
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="zfs-in-place-encryption.html" title="ZFS in-place Encryption" class="md-nav__link">
      ZFS in-place Encryption
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Tips
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Tips
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/ansible.html" title="Ansible" class="md-nav__link">
      Ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/backblaze.html" title="Backblaze" class="md-nav__link">
      Backblaze
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/coreos.html" title="CoreOS" class="md-nav__link">
      CoreOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/docker.html" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/documentscan.html" title="Document Scanning" class="md-nav__link">
      Document Scanning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/freeipa.html" title="FreeIPA" class="md-nav__link">
      FreeIPA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/git.html" title="Git" class="md-nav__link">
      Git
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/gitlab.html" title="Gitlab" class="md-nav__link">
      Gitlab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/golang.html" title="Go" class="md-nav__link">
      Go
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/lenovo.html" title="Lenovo" class="md-nav__link">
      Lenovo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/openwrt.html" title="OpenWRT" class="md-nav__link">
      OpenWRT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/python.html" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/restic.html" title="Restic" class="md-nav__link">
      Restic
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tips/tor.html" title="Tor" class="md-nav__link">
      Tor
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tools" title="Tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guides" title="Guides" class="md-nav__link">
    Guides
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arch-linux" title="Arch Linux" class="md-nav__link">
    Arch Linux
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fedora" title="Fedora" class="md-nav__link">
    Fedora
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-packages" title="Required Packages" class="md-nav__link">
    Required Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signing-keys" title="Signing keys" class="md-nav__link">
    Signing keys
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-your-kernels" title="Sign your kernels" class="md-nav__link">
    Sign your kernels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-systemd-boot" title="Use systemd-boot" class="md-nav__link">
    Use systemd-boot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-your-bootloader" title="Sign your bootloader" class="md-nav__link">
    Sign your bootloader
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reboot" title="Reboot" class="md-nav__link">
    Reboot
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ansemjo/wiki/edit/master/docs/security/secureboot.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="secureboot">Secureboot</h1>
<p>These are guides to install your system with your own secureboot keys and enforce
signed Linux kernels.</p>
<h2 id="tools">Tools</h2>
<p>Some useful tools for this job:</p>
<table>
<thead>
<tr>
<th align="center">name</th>
<th align="left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><a href="https://github.com/ansemjo/mkefikeys"><code>ansemjo/mkefikeys</code></a></td>
<td align="left">generate signing keys</td>
</tr>
<tr>
<td align="center"><a href="https://github.com/ansemjo/mksignkernels"><code>ansemjo/mksignkernels</code></a></td>
<td align="left">bundle and sign kernel images</td>
</tr>
</tbody>
</table>
<h2 id="guides">Guides</h2>
<h3 id="arch-linux">Arch Linux</h3>
<p>TODO</p>
<h3 id="fedora">Fedora</h3>
<h4 id="installation">Installation</h4>
<p>Do a somewhat standard installation on an UEFI system. I used the <code>Fedora 28 Server netinst</code> image.</p>
<p>During partitioning, make sure to select at least "custom" partitioning and add a seperate EFI system partition in <code>/boot/efi</code>. Tick the boxes to encrypt your <code>/</code> and any <code>swap</code> partitions you might create. Technically, a seperate <code>/boot</code> partition is not required with the bundled kernels we are going to use but Anaconda complains otherwise and you will not be able to boot the system after installation. You could probably do all these steps from within a live rescue system but I haven't tried that route yet.</p>
<h4 id="required-packages">Required Packages</h4>
<p>You will need to additionally (after a minimal setup) install:
<em> git
</em> make
<em> binutils
</em> sbsigntools</p>
<p>Then clone and install the above two tools: <code>mkefikeys</code> and <code>mksignkernels</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="p">...</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">ansemjo</span><span class="o">/</span><span class="n">mkefikeys</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">ansemjo</span><span class="o">/</span><span class="n">mksignkernels</span>
<span class="p">(</span><span class="n">cd</span> <span class="n">mkefikeys</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">make</span> <span class="o">-</span><span class="n">f</span> <span class="n">install</span><span class="p">.</span><span class="n">mk</span> <span class="n">install</span><span class="p">)</span>
<span class="p">(</span><span class="n">cd</span> <span class="n">mksignkernels</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">make</span> <span class="o">-</span><span class="n">f</span> <span class="n">install</span><span class="p">.</span><span class="n">mk</span> <span class="n">install</span><span class="p">)</span>
</pre></div>


<h4 id="signing-keys">Signing keys</h4>
<p>Create a set of signing keys in <code>/etc/efikeys</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">efikeys</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">efikeys</span>
<span class="n">mkefikeys</span> <span class="n">certs</span> <span class="n">der</span>
</pre></div>


<p>The <code>der</code> target is required to output DER-encoded certificates in case you need to install those in your firmware. This is the case for OVMF, i.e. KVM machines. My Thinkpad needs authenticated "efi signature lists" .. generate them with <code>mkefikeys auth</code>.</p>
<p>Copy files required for installation to the unencrypted ESP:</p>
<div class="codehilite"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">efikeys</span><span class="cm">/*.cer /boot/efi</span>
</pre></div>


<p>Installing them in your firmware is out of the scope of this entry.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not enable Secureboot yet. We haven't signed anything yet and your system will fail to boot.</p>
</div>
<h4 id="sign-your-kernels">Sign your kernels</h4>
<p>Now we need to sign the kernels. Simply running <code>mksignkernels</code> will probably fail with a not-so-useful error message because something will be missing. On virtual machines the Intel microcode is usually not useful and thus not present. Add an empty <code>MICROCODE =</code> line in <code>/etc/mksignkernels.mk</code>.</p>
<p>Additionally, you'll want to use the same kernel commandline as is used for your  default installation. You can get the commandline of currently running kernel from <code>cat /proc/cmdline</code>.</p>
<div class="codehilite"><pre><span></span><span class="c"># blablabla</span>
<span class="c"># ------- custom targets --------</span>

<span class="nv">MICROCODE</span> <span class="o">=</span> 
<span class="nv">CMDLINE</span> <span class="o">=</span> whatever_your_default_kernel_uses
</pre></div>


<p>Next, we need to create the output directory:</p>
<div class="codehilite"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span><span class="o">/</span><span class="n">EFI</span><span class="o">/</span><span class="n">Linux</span>
</pre></div>


<p>Running <code>mksignkernels</code> should succeed now. Otherwise check all the prerequisites:</p>
<ul>
<li>EFI stub in <code>/usr/lib/systemd/boot/efi/linuxx64.efi.stub</code></li>
<li>Signing keys in <code>/etc/efikeys/DatabaseKey.{key,crt}</code></li>
<li>Kernel in <code>/boot/vmlinuz-*</code></li>
<li>Initramfs in corresponding <code>/boot/initramfs-*.img</code></li>
</ul>
<h4 id="use-systemd-boot">Use systemd-boot</h4>
<p>Check that <code>systemd-boot</code> is installed and you are indeed running UEFI, yadda yadda ..</p>
<div class="codehilite"><pre><span></span><span class="n">bootctl</span> <span class="n">status</span>
</pre></div>


<p>To install it as the default bootloader, simply issue:</p>
<div class="codehilite"><pre><span></span><span class="n">bootctl</span> <span class="n">install</span>
</pre></div>


<p>To enable the selection prompt uncomment the <code>timeout</code> in <code>/boot/efi/loader/loader.conf</code>. Otherwise it directly boots the default kernel.</p>
<h4 id="sign-your-bootloader">Sign your bootloader</h4>
<p>Before you reboot and attempt to enable Secureboot now, you need to sign the bootloader itself:</p>
<div class="codehilite"><pre><span></span><span class="n">mksignkernels</span> <span class="n">sign</span> <span class="n">SIGN</span><span class="o">=/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">systemd</span><span class="o">-</span><span class="n">bootx64</span><span class="p">.</span><span class="n">efi</span>
<span class="n">mksignkernels</span> <span class="n">sign</span> <span class="n">SIGN</span><span class="o">=/</span><span class="n">boot</span><span class="o">/</span><span class="n">efi</span><span class="o">/</span><span class="n">BOOT</span><span class="o">/</span><span class="n">BOOTX64</span><span class="p">.</span><span class="n">EFI</span>
</pre></div>


<p>I actually do not know if both are necessary, I just signed both just in case.</p>
<h4 id="reboot">Reboot</h4>
<p>When you reboot you should see systemd-boot's selection prompt instead of GRUB. If that is the case, there should be an option to "Reboot into Firmware Setup".
Do that and enable Secureboot now.</p>
<p>If all went fine you should be able to normally boot your system now. Starting your machine via GRUB should fail though, as neither GRUB nor any of the kernels it tries to boot are signed.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="net-disk-decryption.html" title="Network Disk Decryption" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Network Disk Decryption
              </span>
            </div>
          </a>
        
        
          <a href="systemd-decryption-target.html" title="Systemd Disk Decryption Target" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Systemd Disk Decryption Target
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright (c) 2018 Anton Semjonov, licensed under Creative Commons BY-SA 4.0 (https://semjonov.de/license)
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a353778b.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>